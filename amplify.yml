version: 1
applications:
  - appRoot: .
    backend:
      phases:
        preBuild:
          commands:
            - pip install --upgrade pip
            - pip install -r requirements.txt
            # Install MeiliSearch
            - curl -L https://install.meilisearch.com | sh
            - mv meilisearch /usr/local/bin/
            - chmod +x /usr/local/bin/meilisearch
        build:
          commands:
            # Start MeiliSearch in the background
            - nohup /usr/local/bin/meilisearch --master-key ${MEILI_MASTER_KEY} --db-path ./data.ms --env production &
            # Wait for MeiliSearch to be ready
            - |
              echo "Waiting for MeiliSearch to be ready..."
              until curl -s "http://localhost:7700/health" > /dev/null; do
                sleep 1
              done
            - echo "MeiliSearch is ready!"
        postBuild:
          commands:
            - echo "PostBuild phase"
      artifacts:
        baseDirectory: .
        files:
          - '**/*'
        excludes:
          - data.ms/**/*
          - __pycache__/**/*
          - *.pyc
          - .git/**/*
      cache:
        paths:
          - /root/.cache/pip
    frontend:
      phases:
        build:
          commands:
            - echo "No frontend build required"
      artifacts:
        baseDirectory: static
        files:
          - '**/*'
    environmentVariables:
      - name: FLASK_APP
        value: app.py
      - name: FLASK_ENV
        value: production
      - name: MEILISEARCH_URL
        value: http://localhost:7700
    buildSpec:
      version: 1
      frontend:
        phases:
          build:
            commands:
              - echo "No frontend build required"
        artifacts:
          baseDirectory: static
          files:
            - '**/*'
      backend:
        phases:
          build:
            commands:
              - pip install -r requirements.txt
        artifacts:
          baseDirectory: .
          files:
            - '**/*'
    customHeaders:
      - pattern: '**/*'
        headers:
          - key: 'Cache-Control'
            value: 'max-age=0, no-cache, no-store, must-revalidate' 